# Implementation Plan: Sprint 1 - Core Ansible Features

**Created**: 2025-09-06T11:50:01Z  
**Last Updated**: 2025-09-06T11:50:01Z  
**Status**: IN_PROGRESS  

## üéØ Task Analysis

### Requirements
- [ ] Check Mode (`--check`) - Dry run capability for all modules
- [ ] Diff Mode (`--diff`) - Show what changes will be made
- [ ] Systemd Module - Service management (start/stop/restart/enable/disable)
- [ ] LineInFile Module - Edit specific lines in configuration files
- [ ] Comprehensive unit tests for all features

### Current State Analysis
- **Existing Code**: BaseModule provides foundation, module interface defined
- **Integration Points**: TaskRunner, ExecuteOptions, Result types need enhancement
- **Dependencies**: No new external dependencies needed initially
- **Potential Conflicts**: Must maintain backward compatibility with existing modules

### Success Criteria
- [ ] Check mode works with all existing modules
- [ ] Diff mode provides clear before/after comparison
- [ ] Systemd module handles common service operations
- [ ] LineInFile module supports regex and line operations
- [ ] All tests pass with >90% coverage
- [ ] No breaking changes to existing API

## üìã Implementation Steps

### Step 1: Add Check/Diff Mode Types and Interfaces
**Status**: ‚úÖ COMPLETED  
**Estimated Complexity**: Medium  
**Integration Risk**: Low  

**What to do**:
- Add CheckMode and DiffMode to ExecuteOptions
- Create DiffResult type for diff output
- Add ModuleCapabilities interface
- Update Result type with diff and simulated fields

**Files to create/modify**:
- `pkg/types/types.go` - Add new types
- `pkg/types/capabilities.go` - New capabilities interface

**Integration checks**:
- [ ] Code compiles
- [ ] Existing tests pass
- [ ] Types are exported correctly

**Commit message**: `step1: add check/diff mode types and interfaces`

---

### Step 2: Enhance BaseModule with Mode Support
**Status**: ‚úÖ COMPLETED  
**Dependencies**: Step 1  
**Estimated Complexity**: Medium  

**What to do**:
- Add CheckMode() and DiffMode() helper methods
- Implement RunWithModes wrapper
- Add CreateCheckModeResult helper
- Add diff generation utilities

**Files to modify**:
- `pkg/modules/base.go` - Add mode support methods
- `pkg/modules/base_test.go` - Unit tests

**Integration checks**:
- [x] BaseModule methods work correctly
- [x] Existing modules still function
- [x] Tests cover new functionality

**Commit message**: `step2: enhance BaseModule with check/diff mode support`

---

### Step 3: Update Runner and CLI for Mode Flags
**Status**: ‚úÖ COMPLETED  
**Dependencies**: Step 2  
**Estimated Complexity**: Medium  

**What to do**:
- Add --check and --diff flags to CLI
- Pass mode flags through TaskRunner
- Update execution chain to respect modes
- Add mode validation

**Files to modify**:
- `cmd/gosinble/main.go` - Add CLI flags
- `pkg/runner/runner.go` - Pass modes through execution
- `tests/integration/check_diff_mode_test.go` - Integration tests

**Integration checks**:
- [x] CLI flags work correctly
- [x] Modes propagate to modules
- [x] No performance regression
- [x] RunWithModes support for capable modules
- [x] Comprehensive integration tests

**Commit message**: `step3: update Runner and CLI for check/diff mode flags`

---

### Step 4: Create Module Test Helper Framework
**Status**: ‚è≥ IN_PROGRESS  
**Dependencies**: Step 3  
**Estimated Complexity**: High  

**What to do**:
- Create ModuleTestHelper struct
- Implement MockConnection for testing
- Add MockFileSystem for file operations
- Create test utilities for common scenarios

**Files to create**:
- `pkg/testing/mock_connection.go` - Mock connection
- `pkg/testing/mock_filesystem.go` - Mock file system
- `pkg/testing/module_test_helper.go` - Test helper framework
- `pkg/testing/specialized_helpers.go` - Domain-specific helpers

**Integration checks**:
- [ ] Helper framework works correctly
- [ ] Mocks behave as expected
- [ ] Can test modules without real system

**Commit message**: `step4: create module test helper framework`

---

### Step 5: Implement Systemd Module
**Status**: ‚ùå TODO  
**Dependencies**: Step 4  
**Estimated Complexity**: High  

**What to do**:
- Create SystemdModule with service operations
- Implement state management (start/stop/restart)
- Add enable/disable functionality
- Support check mode and diff output
- Handle different init systems gracefully

**Files to create**:
- `pkg/modules/systemd.go` - Systemd module implementation
- `pkg/modules/systemd_test.go` - Comprehensive tests
- `pkg/modules/systemd_doc.go` - Documentation

**Integration checks**:
- [ ] Module compiles and registers
- [ ] Check mode works correctly
- [ ] Tests pass without root
- [ ] Handles missing systemd gracefully

**Commit message**: `step5: implement systemd module with full test coverage`

---

### Step 6: Implement LineInFile Module
**Status**: ‚ùå TODO  
**Dependencies**: Step 5  
**Estimated Complexity**: High  

**What to do**:
- Create LineInFileModule with regex support
- Implement line insertion/removal logic
- Add backup file creation
- Support insertafter/insertbefore options
- Implement atomic file updates

**Files to create**:
- `pkg/modules/lineinfile.go` - LineInFile module
- `pkg/modules/lineinfile_test.go` - Comprehensive tests
- `pkg/modules/lineinfile_doc.go` - Documentation
- `pkg/modules/line_processor.go` - Line processing logic

**Integration checks**:
- [ ] Module handles all edge cases
- [ ] Atomic updates work correctly
- [ ] Regex patterns work as expected
- [ ] Backup files created properly

**Commit message**: `step6: implement lineinfile module with atomic updates`

---

### Step 7: Integration Testing
**Status**: ‚ùå TODO  
**Dependencies**: Step 6  
**Estimated Complexity**: Medium  

**What to do**:
- Create integration tests for all features
- Test mode combinations
- Verify backward compatibility
- Performance benchmarks

**Files to create/modify**:
- `tests/integration/check_mode_test.go` - Check mode tests
- `tests/integration/systemd_test.go` - Systemd integration
- `tests/integration/lineinfile_test.go` - LineInFile integration

**Integration checks**:
- [ ] All integration tests pass
- [ ] No breaking changes
- [ ] Performance acceptable

**Commit message**: `step7: add comprehensive integration tests`

---

### Step 8: Documentation and Examples
**Status**: ‚ùå TODO  
**Dependencies**: Step 7  
**Estimated Complexity**: Low  

**What to do**:
- Update README with new features
- Create example playbooks
- Document module parameters
- Add migration guide

**Files to create/modify**:
- `README.md` - Update with new features
- `examples/check-mode-demo/main.go` - Check mode example
- `examples/systemd-example/main.go` - Systemd usage
- `examples/lineinfile-example/main.go` - LineInFile usage

**Commit message**: `step8: add documentation and examples for Sprint 1`

## üîÑ Progress Log

### 2025-09-06T11:50:01Z - Plan Created
- **What was done**: Created comprehensive implementation plan
- **Next step**: Begin Step 1 - Add Check/Diff Mode Types

### 2025-09-06T11:55:00Z - Step 1 Completed
- **What was done**: Added check/diff mode types and interfaces
- **Files modified**: 
  - `pkg/types/types.go` - Added DiffResult, updated Result and ExecuteOptions, added mode fields to Task
  - `pkg/types/capabilities.go` - Created ModuleCapabilities interface
- **Integration results**: All tests pass, no breaking changes
- **Next step**: Enhance BaseModule with mode support

### 2025-09-06T12:10:00Z - Step 2 Completed
- **What was done**: Enhanced BaseModule with check/diff mode support
- **Files modified**: 
  - `pkg/modules/base.go` - Added strict CheckMode, GenerateDiff, Capabilities methods, RunWithModes wrapper
  - `pkg/modules/base_test.go` - Created comprehensive tests for all new functionality
- **Integration results**: All BaseModule tests pass, proper type checking for modes
- **Next step**: Update Runner and CLI for mode flags

### 2025-09-06T12:30:00Z - Step 3 Completed
- **What was done**: Updated Runner and CLI for check/diff mode flags
- **Files modified**:
  - `pkg/runner/runner.go` - Enhanced to support both _check_mode and ansible_check_mode vars, added RunWithModes support
  - `cmd/gosinble/main.go` - Updated displayResults to show diff output
  - `tests/integration/check_diff_mode_test.go` - Comprehensive integration tests for check/diff modes
- **Integration results**: All integration tests pass, proper mode propagation to modules
- **Next step**: Create Module Test Helper Framework

## üö® Issues & Challenges

*No issues yet*

## üß™ Integration Testing Checklist

After each step:
- [ ] Code compiles without errors
- [ ] All existing tests pass
- [ ] New functionality works as expected
- [ ] No performance regressions
- [ ] No security issues introduced
- [ ] Follows project coding standards

## üìÅ Modified Files
*To be updated as implementation progresses*

## üéØ Final Verification
- [ ] Check mode works with all modules
- [ ] Diff mode provides useful output
- [ ] Systemd module handles all states
- [ ] LineInFile module is reliable
- [ ] All tests pass
- [ ] Documentation complete
- [ ] Examples work correctly
- [ ] No breaking changes